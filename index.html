<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sydney Meshcore Network Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                   background: rgba(0,0,0,0.9); color: white; padding: 40px 60px; border-radius: 15px; 
                   z-index: 10000; text-align: center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; 
                   width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading"><div>Loading Network Map...</div><div class="spinner"></div></div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        fetch('network_map_data.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                const lats = [], lons = [];
                Object.values(data.nodes || {}).forEach(n => { 
                    if (n.lat && n.lon) { lats.push(n.lat); lons.push(n.lon); }
                });
                const lat = lats.length ? lats.reduce((a,b)=>a+b)/lats.length : -33.8688;
                const lon = lons.length ? lons.reduce((a,b)=>a+b)/lons.length : 151.2093;
                const map = L.map('map').setView([lat, lon], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18}).addTo(map);
                Object.entries(data.nodes || {}).forEach(([k,n]) => {
                    if (n.lat && n.lon) {
                        const color = n.type === 1 ? '#3388ff' : n.type === 2 ? '#ff3333' : n.type === 3 ? '#33cc33' : '#808080';
                        L.circleMarker([n.lat, n.lon], {radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.8})
                            .addTo(map).bindPopup('<b>' + (n.name || 'Unknown') + '</b><br>Type: ' + (n.type || 0));
                    }
                });
                (data.links || []).forEach(link => {
                    const from = Object.values(data.nodes).find(n => n.name && k.startsWith(link.from_prefix));
                    const to = data.nodes[link.to_pubkey];
                    if (from && to && from.lat && to.lat) {
                        const snr = link.snr || 0;
                        const color = snr > 0 ? '#4caf50' : snr > -5 ? '#ffc107' : '#f44336';
                        L.polyline([[from.lat, from.lon], [to.lat, to.lon]], {color: color, weight: 3, opacity: 0.6}).addTo(map);
                    }
                });
            });
    </script>
</body>
</html>
